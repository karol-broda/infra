#!/usr/bin/env bash
set -euo pipefail
cd "$(git rev-parse --show-toplevel)"

HOST="${1:?host required}"

# read wifi credentials from 1password
echo "reading secrets from 1password for $HOST..."
WIFI_SSID=$(op item get "$HOST-wifi" --fields label=ssid 2>/dev/null || echo "")
WIFI_PSK=$(op item get "$HOST-wifi" --fields label=psk 2>/dev/null || echo "")

if [ -z "$WIFI_SSID" ] || [ -z "$WIFI_PSK" ]; then
  echo "error: wifi credentials not found in 1password"
  echo "create an item called '$HOST-wifi' with fields 'ssid' and 'psk'"
  exit 1
fi

# create/update sops secrets file
SECRETS_FILE="secrets/$HOST.yaml"
echo "updating $SECRETS_FILE..."

cat > "$SECRETS_FILE.tmp" << EOF
wifi_ssid: $WIFI_SSID
wifi_psk: $WIFI_PSK
EOF

sops -e -i "$SECRETS_FILE.tmp"
mv "$SECRETS_FILE.tmp" "$SECRETS_FILE"

echo "done! secrets synced from 1password to $SECRETS_FILE"

