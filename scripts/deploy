#!/usr/bin/env bash
set -euo pipefail

cd "$(git rev-parse --show-toplevel)"

HOST="${1:-}"
if [ -z "$HOST" ]; then
  echo "usage: deploy <hostname>"
  echo ""
  echo "available hosts:"
  nix flake show --json 2>/dev/null | jq -r '.nixosConfigurations | keys[]' 2>/dev/null || echo "  (run from project root to see hosts)"
  exit 1
fi

if [ ! -f terraform/terraform.tfstate ]; then
  echo "error: terraform state not found. run 'tf apply' first."
  exit 1
fi

SERVER_IP=$(cd terraform && terraform output -json servers 2>/dev/null | jq -r ".\"$HOST\".ipv4 // empty")
if [ -z "$SERVER_IP" ]; then
  echo "error: could not get ip for host '$HOST'. check terraform state."
  exit 1
fi

SSH_KEY="keys/${HOST}-key"
if [ ! -f "$SSH_KEY" ]; then
  echo "error: ssh key not found at $SSH_KEY"
  exit 1
fi

echo "deploying nixos to $HOST ($SERVER_IP)..."
nix run github:nix-community/nixos-anywhere -- \
  --flake ".#$HOST" \
  "root@$SERVER_IP" \
  -i "$SSH_KEY"

